<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Magnifi - Magnifying Glass Camera</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #111;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    color: #fff;
    overflow: hidden;
  }
  h1 { margin: 10px 0; text-align:center; }
  #cameraContainer {
    position: relative;
    width: 90%;
    max-width: 600px;
    border-radius: 20px;
    overflow: hidden;
    touch-action: none;
  }
  video { width: 100%; display: block; filter: brightness(1); }
  #magnifier {
    position: absolute;
    border: 4px solid #fff;
    border-radius: 50%;
    width: 150px;
    height: 150px;
    overflow: hidden;
    pointer-events: none;
    box-shadow: 0 0 15px rgba(255,255,255,0.5);
    display: none;
  }
  #magnifier video {
    position: absolute;
    transform-origin: top left;
  }
  #controls {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
  }
  button, input[type="range"] {
    padding: 8px 15px;
    font-size: 16px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
  }
  button { background: #333; color: #fff; transition: 0.2s; }
  button:hover { background: #555; }
  button.active { background: #6c5ce7; }
</style>
</head>
<body>

<h1>Magnifi</h1>
<div id="cameraContainer">
  <video id="camera" autoplay playsinline></video>
  <div id="magnifier">
    <video id="magnifierVideo" autoplay playsinline muted></video>
  </div>
</div>

<div id="controls">
  <button id="zoomIn">Zoom +</button>
  <button id="zoomOut">Zoom -</button>
  <input type="range" id="zoomSlider" min="1" max="5" step="0.01" value="2">
  <button id="flashToggle">Flashlight ðŸ”¦</button>
</div>

<script>
const video = document.getElementById('camera');
const magnifier = document.getElementById('magnifier');
const magnifierVideo = document.getElementById('magnifierVideo');
const zoomInBtn = document.getElementById('zoomIn');
const zoomOutBtn = document.getElementById('zoomOut');
const zoomSlider = document.getElementById('zoomSlider');
const flashToggle = document.getElementById('flashToggle');
let stream, track, torchOn = false;
let zoomLevel = 2;

// Get rear camera if available
async function getRearCamera() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoDevices = devices.filter(d => d.kind === 'videoinput');
  let rear = videoDevices.find(d => d.label.toLowerCase().includes('back'));
  if (!rear) rear = videoDevices[0]; // fallback
  return rear.deviceId;
}

// Start camera with rear preference
async function startCamera() {
  try {
    const deviceId = await getRearCamera();
    stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId }, audio: false });
    video.srcObject = stream;
    magnifierVideo.srcObject = stream;
    track = stream.getVideoTracks()[0];
  } catch (err) {
    alert('Camera access failed. Please allow permission.');
    console.error(err);
  }
}

// Auto-request camera on load
window.addEventListener('load', () => startCamera());

// Zoom controls
function updateZoom(value) {
  zoomLevel = parseFloat(value);
  magnifierVideo.style.transform = `scale(${zoomLevel}) translate(0,0)`;
  zoomSlider.value = zoomLevel;
}
zoomInBtn.addEventListener('click', () => updateZoom(Math.min(zoomLevel + 0.2, 5)));
zoomOutBtn.addEventListener('click', () => updateZoom(Math.max(zoomLevel - 0.2, 1)));
zoomSlider.addEventListener('input', e => updateZoom(e.target.value));

// Flashlight toggle
flashToggle.addEventListener('click', async () => {
  if (!track) return;
  const capabilities = track.getCapabilities();
  if (!capabilities.torch) { alert('Flashlight not supported'); return; }
  torchOn = !torchOn;
  await track.applyConstraints({ advanced: [{ torch: torchOn }] });
  flashToggle.classList.toggle('active', torchOn);
});

// Magnifier movement
const container = document.getElementById('cameraContainer');
function moveMagnifier(x, y) {
  const rect = container.getBoundingClientRect();
  let mx = x - rect.left - magnifier.offsetWidth / 2;
  let my = y - rect.top - magnifier.offsetHeight / 2;
  if (mx < 0) mx = 0; if (my < 0) my = 0;
  if (mx > rect.width - magnifier.offsetWidth) mx = rect.width - magnifier.offsetWidth;
  if (my > rect.height - magnifier.offsetHeight) my = rect.height - magnifier.offsetHeight;
  magnifier.style.left = mx + 'px';
  magnifier.style.top = my + 'px';
  magnifierVideo.style.transform = `scale(${zoomLevel}) translate(${-mx}px, ${-my}px)`;
}

container.addEventListener('mousemove', e => { magnifier.style.display = 'block'; moveMagnifier(e.clientX, e.clientY); });
container.addEventListener('touchmove', e => { e.preventDefault(); magnifier.style.display='block'; moveMagnifier(e.touches[0].clientX, e.touches[0].clientY); });
container.addEventListener('mouseleave', () => magnifier.style.display = 'none');
container.addEventListener('touchend', () => magnifier.style.display = 'none');
</script>

</body>
</html>
